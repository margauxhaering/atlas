<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HDD vs LDD Atlas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <link href="css/main.css" rel="stylesheet">

</head>
<body>

    <div id="topMenu">
      <h1><a href="index.html">HDD vs LDD Atlas</a></h1>
      <div id="menuButtons">
        <button><a href="index.html">Home</a></button>
        <button><a href="pca.html">PCA</a></button>
        <button><a href="explore.html">Explore annotation</a></button>
      </div>
    </div>
    <div id="popup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>
        <h2>Welcome to the data exploration!</h2>
        <p>To explore this RNA-seq data experiement, you will start by selecting a category on the right by clicking on the purple bar.
        <br><br> The order of the experiment is related to its title of condition.
      <br><br> <b>Example :</b><br> HDD vs LDD - dark : what is up or downregulated is LDD in the dark compared to HDD in the dark, so basically blue represents what's upregulated in LDD and red what's upregulated in HDD.
      <br><br> You have now access to all four comparisons. <br> You can click a dot to highlight the gene but also from the heatmap below.</p>
        <button id="okButton">OK</button>
      </div>
    </div>
<div style="align-items: center;box-sizing: border-box;margin-left:50px;">

  <div style="display: flex; align-items: center; margin: 30px; gap: 20px;">
    <div>
      <input
        type="text"
        id="geneSearch"
        placeholder="ðŸ” Search gene name..."
        style="padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 250px;"
      />
      <button
        id="searchButton"
        style="padding: 8px 12px; border-radius: 8px; border: none; background-color: #4CAF50; color: white; cursor: pointer;"
      >
        Highlight
      </button>
    </div>

    <div
      id="dynamicBox">
      <span id="dynamicText">Results will appear here...</span>
    </div>
  </div>

  <div id="dashboard">
    <div id="scatterContainer" class="chart-box">
      <canvas id="scatterChart"></canvas>
    </div>
    <div id="barContainer" class="chart-box">
      <canvas id="barChart"></canvas>
    </div>
  </div>
    <div id="dashboard2">
                      <div id = "heatmap" style="display:block"></div>
                    </div></div>
  <script>
      const barCtx = document.getElementById('barChart').getContext('2d');
      const scatterCtx = document.getElementById('scatterChart').getContext('2d');

      let barChart, scatterChart;
      let fullData = [];
      let allConditions = [];
      let activeGene = null;

      window.addEventListener('DOMContentLoaded', () => {
        fetch('data/data.json')
          .then(response => {
            if (!response.ok) throw new Error("JSON file not found or inaccessible");
            return response.json();
          })
          .then(jsonData => {
            fullData = validateJSON(jsonData);
            if (!fullData.length) {
              alert("Invalid JSON format â€” must have 'gene', 'log2fc', 'condition', 'annotation', and 'category' fields.");
              return;
            }

            allConditions = [...new Set(fullData.map(d => d.condition))];
            const categoryCounts = computeCategoryCounts(fullData);
            renderBarChart(categoryCounts);
            renderScatterPlot([]);
          })
          .catch(err => {
            console.error("Error loading JSON:", err);
            alert("Failed to load or parse data.json.");
          });
      });

      function validateJSON(data) {
        if (!Array.isArray(data)) return [];
        return data.filter(item =>
          item.gene &&
          typeof item.log2fc === 'number' &&
          item.condition &&
          item.annotation &&
          item.category
        );
      }

      function computeCategoryCounts(data) {
        const categoryGenes = {};

        for (const row of data) {
          if (row.category && row.gene) {
            if (!categoryGenes[row.category]) {
              categoryGenes[row.category] = new Set();
            }
            categoryGenes[row.category].add(row.gene);
          }
        }

        const counts = Object.entries(categoryGenes)
          .map(([category, genes]) => ({
            category,
            count: genes.size,
          }))
          .sort((a, b) => b.count - a.count);

        return counts;
      }

      function renderBarChart(categoryCounts) {
        const labels = categoryCounts.map(d => d.category);
        const counts = categoryCounts.map(d => d.count);

        if (barChart) barChart.destroy();

        const canvas = document.getElementById('barChart');
        const heightPerCategory = 40;
        canvas.height = Math.max(300, labels.length * heightPerCategory);

        const defaultColor = 'rgba(153, 102, 255, 0.6)';
        const highlightColor = 'rgba(255, 205, 86, 0.9)'; // yellow
        const backgroundColors = new Array(labels.length).fill(defaultColor);

        barChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Gene Count',
              data: counts,
              backgroundColor: backgroundColors,
              borderColor: 'rgba(153, 102, 255, 1)',
              borderWidth: 1,
              borderRadius: 6
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const selectedCategory = labels[idx];
                barChart.data.datasets[0].backgroundColor = backgroundColors.map(() => defaultColor);
                barChart.data.datasets[0].backgroundColor[idx] = highlightColor;
                barChart.update();

                updateScatterForCategory(selectedCategory);
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Genes',
                  font: { size: 15, weight: 'bold' }
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Category',
                  font: { size: 15, weight: 'bold' }
                }
              }
            },
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Gene Counts per Category (click to filter)',
                font: { size: 20, weight: 'bold' }
              }
            }
          }
        });
      }

          function getColorForLog2FC(value) {
            if (isNaN(value)) return '#999';
            if (value >= 2) {
              const t = Math.min((value - 2) / 8, 1);
              const r = Math.round(255 - 155 * t);
              const g = Math.round(182 - 182 * t);
              const b = Math.round(193 - 193 * t);
              return `rgb(${r}, ${g}, ${b})`;
            } else if (value <= -2) {
              const t = Math.min((Math.abs(value) - 2) / 8, 1);
              const r = Math.round(173 * (1 - t));
              const g = Math.round(216 * (1 - t));
              const b = 230;
              return `rgb(${r}, ${g}, ${b})`;

            } else {
              return '#cccccc';
            }
          }


          function addJitter() {
            return (Math.random() - 0.5) * 0.5;
          }

          function renderScatterPlot(points, categoryName = '') {
            if (scatterChart) scatterChart.destroy();

            const scatterData = points.map(p => {
              const xIndex = allConditions.indexOf(p.condition);
              return {
                x: xIndex + addJitter(),
                y: p.log2fc,
                backgroundColor: getColorForLog2FC(p.log2fc),
                label: p.gene,
                annot:p.annotation
              };
            });

            scatterChart = new Chart(scatterCtx, {
              type: 'scatter',
              data: {
                datasets: [{
                  label: 'Genes',
                  data: scatterData,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                  borderWidth: 1,
                  borderColor: '#333',
                  backgroundColor: scatterData.map(p => p.backgroundColor)
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                  if (elements.length > 0) {
                    const idx = elements[0].index;
                    const gene = scatterData[idx].label;
                    highlightGene(gene);
                  }
                },
                scales: {
                  x: {
                    type: 'linear',
                    min: -0.5,
                    max: allConditions.length - 0.5,
                    ticks: {
                      callback: (val, index) => {
                        if (index % 2 === 0) return '';
                        const conditionIndex = Math.floor((index - 1) / 2);
                        return allConditions[conditionIndex] || '';
                      }
                    },
                    title: { display: true, text: 'Condition' ,
                      font: {
                        size: 15,
                        weight: 'bold'}}
                  },
                  y: {
                    title: { display: true, text: 'Logâ‚‚FC' ,
                      font: {
                        size: 15,
                        weight: 'bold'}}
                  }
                },
                plugins: {
                  legend: { display: false },
                  title: {
                    display: true,
                    text: categoryName
                      ? `Genes in Category: ${categoryName}`
                      : 'Select a Category from the Bar Chart',
                        font: {
                          size: 20,
                          weight: 'bold'}
                  },
                  tooltip: {
                    callbacks: {
                      label: (context) => {
                        const gene = context.raw.label;
                        const log2fc = context.raw.y;
                        const annot = context.raw.annot;
                        const cond = allConditions[Math.round(context.raw.x)];
                        return `${gene} | ${annot}: Logâ‚‚FC = ${log2fc}`;
                      }

                    }
                  }
                }
              }
            });
          }

          function renderHeatmap(points, categoryName = '') {
            heatmapContainer = document.getElementById('heatmap');
            heatmapContainer.innerHTML = '';


            const genes = [...new Set(points.map(p => p.gene))];
            const conditions = [...new Set(points.map(p => p.condition))];

            const allGenes = [...new Set(points.map(p => p.gene))];
            const allConditions = [...new Set(points.map(p => p.condition))];
            const lookup = {};
            points.forEach(p => {
              if (!lookup[p.gene]) lookup[p.gene] = {};
              lookup[p.gene][p.condition] = p;
            });

            const orderedheatData = [];

            for (const gene of allGenes) {
              const reference = points.find(p => p.gene === gene);

              for (const condition of allConditions) {
                if (lookup[gene] && lookup[gene][condition]) {
                  orderedheatData.push(lookup[gene][condition]);
                } else {
                  orderedheatData.push({
                    gene,
                    condition,
                    log2fc: 0,
                    FDR: null,
                    annotation: reference.annotation,
                    category: reference.category
                  });
                }
              }
            }

        var myGroups = Array.from(new Set(orderedheatData.map(d => d.condition)));
        var myVars = Array.from(new Set(orderedheatData.map(d => d.gene)));


        const containerWidth = heatmapContainer.clientWidth || window.innerWidth - window.innerWidth/20;
        const containerHeight = 400;

        const svg = d3.select("#heatmap")
          .append("svg")
          .attr("width", containerWidth)
          .attr("height", containerHeight + 150)
          .append("g")
          .attr("transform", "translate(100,100)");

        const x = d3.scaleBand()
          .range([0, containerWidth - 150])
          .domain(myVars)
          .padding(0.05);

        const y = d3.scaleBand()
          .range([containerHeight, 0])
          .domain(myGroups)
          .padding(0.05);


        svg.selectAll("rect.cell")
          .data(orderedheatData, d => d.condition + ':' + d.gene)
          .enter()
          .append("rect")
          .attr("class", "cell")
          .attr("x", d => x(d.gene))
          .attr("y", d => y(d.condition))
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .style("fill", d => getColorForLog2FC(d.log2fc))
          .style("stroke-width", 2)
          .style("stroke", d => d.value < 0.05 ? "#9E1F63" : "none")
          .style("cursor", "pointer")
          .on("click", function(event, d) {
            highlightGene(event.gene);
          });

          function reorderHeatmap(order) {
            const sub = orderedheatData.filter(obj => obj.condition === order[0]);
            sub.sort((a, b) => a.log2fc - b.log2fc);
            const geneorder = sub.map(obj => obj.gene);
            x.domain(geneorder);
            y.domain(order);

            svg.selectAll("rect")
              .transition()
              .duration(1000)
              .attr("x", d => x(d.gene))
              .attr("y", d => y(d.condition));

            svg.selectAll(".row-label")
              .transition()
              .duration(1000)
              .attr("y", d => y(d) + y.bandwidth() / 2);

            svg.selectAll(".col-label")
              .transition()
              .duration(1000)
              .attr("y", d => x(d) + x.bandwidth()/2);
          }
          svg.selectAll(".col-label")
            .data(myVars)
            .enter().append("text")
            .attr("class", "col-label")
            .attr("y", d => x(d) + x.bandwidth()/2)
            .attr("x", 3)
            .attr("transform", "rotate(-90)")
            .style("text-anchor", "start")
            .style("font-size", 8)
            .style("font-family", "Montserrat, Arial")
            .style("cursor", "pointer")
            .text(d => d)
            .on("click", function(event, d) {
              highlightGene(event);
            });


      svg.selectAll(".row-label")
        .data(myGroups)
        .enter().append("text")
        .attr("class", "row-label")
        .attr("x", -100)
        .attr("y", d => y(d) + y.bandwidth()/2)
        .attr("dy", ".32em")
        .style("cursor", "pointer")
        .style("font-size", 12)
        .text(d => d)
        .on("click", function(d) {
          var currentOrder = myGroups.slice();
          var index = currentOrder.indexOf(d);
          if (index !== -1) {
            currentOrder.splice(index, 1);
            currentOrder.unshift(d);
          }
          reorderHeatmap(currentOrder);
        });


          }

          function updateScatterForCategory(category) {
            activeGene = null;
            const subset = fullData.filter(d => d.category === category);
            renderScatterPlot(subset, category);
            renderHeatmap(subset, category);
          }


          function highlightGeneInHeatmap(gene) {

          d3.select("#heatmap").selectAll("rect.cell")
              .style("stroke", d => d.value < 0.05 ? "#9E1F63" : "none")
              .style("stroke-width", 2)
              .style("opacity", 1);
            d3.select("#heatmap").selectAll(".col-label")
              .style("font-weight", "normal")
              .style("fill", "black");
            d3.select("#heatmap").selectAll("rect.cell")
              .filter(d => d.gene === gene)
              .style("stroke", "#000")
              .style("stroke-width", 3)
              .raise();

            d3.select("#heatmap").selectAll(".col-label")
              .filter(d => d === gene)
              .style("font-weight", "bold")
              .style("fill", "darkgreen");
          }



          function highlightGene(gene) {
            activeGene = gene;
            const dataset = scatterChart.data.datasets[0];
            dataset.data.sort((a, b) => (a.label === gene ? 1 : 0) - (b.label === gene ? 1 : 0));

            dataset.pointRadius = dataset.data.map(d => d.label === gene ? 12 : 6);
            dataset.borderWidth = dataset.data.map(d => d.label === gene ? 3 : 1);
            dataset.borderColor = dataset.data.map(d => d.label === gene ? '#000' : '#333');
            dataset.backgroundColor = dataset.data.map(d =>
              d.label === gene ? 'rgba(144, 238, 144, 1)' : getColorForLog2FC(d.y)
            );

              scatterChart.update();
              highlightGeneInHeatmap(gene);
              const geneData = fullData.find(d => d.gene === gene);
              const annotation = geneData ? geneData.annotation : 'N/A';
              const dynamicText = document.getElementById("dynamicText");
              dynamicText.innerHTML = `Current highlighted Gene: <b>${gene}</b> and its annotation is: <b>${annotation}</b>`;
          }


          const geneSearchInput = document.getElementById("geneSearch");
          const searchButton = document.getElementById("searchButton");

          geneSearchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              handleGeneSearch();
            }
          });
          searchButton.addEventListener("click", handleGeneSearch);

          function handleGeneSearch() {
            const query = geneSearchInput.value.trim();
            if (!query) return;

            const geneExists = fullData.some(d => d.gene.toLowerCase() === query.toLowerCase());
            if (!geneExists) {
              alert(`Gene "${query}" not found in the current dataset.`);
              return;
            }
            document.getElementById("scatterContainer").scrollIntoView({ behavior: "smooth" });
            highlightGene(query);


          }


          window.addEventListener('load', () => {
            const popup = document.getElementById('popup');
            const closeBtn = document.querySelector('.close');
            const okButton = document.getElementById('okButton');

            popup.style.display = 'block';


            closeBtn.addEventListener('click', () => popup.style.display = 'none');
            okButton.addEventListener('click', () => popup.style.display = 'none');

            window.addEventListener('click', (e) => {
              if (e.target === popup) popup.style.display = 'none';
            });
          });


        </script>
</body>
</html>
